# AGENTS.md - AI Agent Instructions for customLayout

This document provides guidance for AI agents working with the customLayout R package.

## Package Overview

**customLayout** is an R package that extends the basic `layout` function from the graphics package to create complex drawing areas by combining simpler layouts. It supports:

- Base graphics systems
- Grid graphics (ggplot2, gridExtra)
- PowerPoint slides via the `officer` package

**Version:** 0.3.5
**License:** GPL-3
**Author:** Zygmunt Zawadzki

## Project Structure

```
customLayout/
├── R/                      # Source code
│   ├── Layout.R            # Core layout creation and combination
│   ├── officer.R           # PowerPoint integration
│   ├── asserts.R           # Assertion/validation functions
│   ├── utils.R             # Utility functions
│   ├── flextable.R         # Table formatting for PowerPoint
│   ├── splitField.R        # Field splitting functionality
│   └── repColsRows.R       # Row/column repetition helpers
├── tests/
│   ├── testthat.R          # Test setup
│   └── testthat/           # Test files
├── vignettes/              # R Markdown vignettes
├── man/                    # Generated documentation (do not edit)
├── DESCRIPTION             # Package metadata
├── NAMESPACE               # Exports (auto-generated by roxygen2)
└── _pkgdown.yml            # Website configuration
```

## Key Functions

### Core Layout Functions

| Function | Purpose |
|----------|---------|
| `lay_new()` | Create a new CustomLayout object from a matrix |
| `lay_show()` | Display layout structure on graphics device |
| `lay_set()` | Initialize drawing area with the layout |
| `lay_grid()` | Use layout with grid graphics (ggplot2) |

### Layout Combination Functions

| Function | Purpose |
|----------|---------|
| `lay_bind_col()` | Combine two layouts horizontally |
| `lay_bind_row()` | Combine two layouts vertically |
| `lay_split_field()` | Split a field using another layout |

### PowerPoint Functions (phl_*)

| Function | Purpose |
|----------|---------|
| `phl_layout()` | Create layout for PowerPoint slides |
| `phl_with_gg()` | Add ggplot to PowerPoint |
| `phl_with_vg()` | Add vector graphics to PowerPoint |
| `phl_with_plot()` | Add base plot as PNG |
| `phl_with_text()` | Add text to placeholder |
| `phl_with_table()` | Add data.frame as table |
| `phl_with_flextable()` | Add formatted flextable |

## Development Workflow

### Running Tests

```r
# Run all tests
devtools::test()

# Run specific test file
testthat::test_file("tests/testthat/test-basic.R")
```

### Building and Checking

```r
# Build documentation
devtools::document()

# Check package
devtools::check()

# Build package
devtools::build()
```

### Testing Approach

The package uses:
- `testthat` for unit testing
- `vdiffr` for visual regression testing
- Custom `expect_pptx_identical()` for PowerPoint comparison

Tests are located in `tests/testthat/`:
- `test-basic.R` - Core layout functionality
- `test-officer.R` - PowerPoint integration
- `test-asserts.R` - Assertion functions
- `test-flextable.R` - Table formatting
- `test-split-field.R` - Field splitting
- `test-reps-functions.R` - Repetition helpers
- `test-utils.R` - Utility functions

## Documentation

### Roxygen2

All functions are documented using roxygen2 comments. After modifying documentation:

```r
devtools::document()
```

### Vignettes

Located in `vignettes/`:
- `customlayout-cookbook.Rmd` - Practical recipes
- `layouts-for-officer-power-point-document.Rmd` - PowerPoint guide
- `Roadmap.Rmd` - Future development plans

## Architecture Notes

### S3 Classes

- **CustomLayout**: Core layout object with `mat`, `widths`, `heights`
- **OfficerCustomLayout**: Layout positions for PowerPoint

### Key Design Patterns

1. Layouts are represented as matrices with width/height vectors
2. Layouts can be combined recursively using `lay_bind_col()` and `lay_bind_row()`
3. GCD/SCM mathematics used for proper ratio scaling when combining

### Deprecated Functions

Old naming convention functions are deprecated but still work:
- `layCreate()` → `lay_new()`
- `laySet()` → `lay_set()`
- `layShow()` → `lay_show()`
- `layGrid()` → `lay_grid()`
- `layColBind()` → `lay_bind_col()`
- `layRowBind()` → `lay_bind_row()`
- `laySplitField()` → `lay_split_field()`

## Dependencies

**Required:**
- gridExtra, graphics, utils
- RColorBrewer
- officer (>= 0.3.6)
- flextable (>= 0.5.6)
- assertthat
- rvg (>= 0.2.2)

**Testing:**
- testthat, vdiffr, covr

## Common Tasks

### Adding a New Function

1. Add function code in appropriate `R/*.R` file
2. Document with roxygen2 comments
3. Run `devtools::document()` to update NAMESPACE and man/
4. Add tests in `tests/testthat/`
5. Run `devtools::check()` to verify

### Modifying Existing Functions

1. Read the existing code and tests
2. Make changes in the R/ file
3. Update documentation if needed
4. Run existing tests to ensure no regressions
5. Add new tests for changed behavior

### Working with PowerPoint Functions

PowerPoint functions use the `officer` package. Test files are in `tests/pptx/`. Use `expect_pptx_identical()` for comparing PowerPoint outputs.

## CI/CD

- **Travis CI**: Tests on R devel, release, oldrel
- **AppVeyor**: Windows testing
- **Codecov**: Code coverage reporting

## Code Style

- Use snake_case for new functions (e.g., `lay_new()`, `phl_with_gg()`)
- Prefix layout functions with `lay_`
- Prefix PowerPoint functions with `phl_`
- Include `@export` in roxygen2 for public functions
- Use `@noRd` for internal helper functions
